<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>LVS+Keepalived+MySQL主主复制实现MySQL高可用 | SunnyWs'Blog</title><meta name="keywords" content="MySQL"><meta name="author" content="SunnyWs"><meta name="copyright" content="SunnyWs"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="LVS+Keepalived+MySQL主主复制实现MySQL高可用LVS概述 LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统， 是中国国内最早出现的自由软件项目之一。目前LVS已经被集成到Linux内核模块中  LVS是Linux virtual server的缩写，为linux虚拟服务器，是一个虚拟的服务器集群系统。 LVS简单工作">
<meta property="og:type" content="article">
<meta property="og:title" content="LVS+Keepalived+MySQL主主复制实现MySQL高可用">
<meta property="og:url" content="https://sunnyws.com/posts/c05f2321/index.html">
<meta property="og:site_name" content="SunnyWs&#39;Blog">
<meta property="og:description" content="LVS+Keepalived+MySQL主主复制实现MySQL高可用LVS概述 LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统， 是中国国内最早出现的自由软件项目之一。目前LVS已经被集成到Linux内核模块中  LVS是Linux virtual server的缩写，为linux虚拟服务器，是一个虚拟的服务器集群系统。 LVS简单工作">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sunnyws/BlogAssets@master/img/blogimg/LVS+Keepalived+MySQL主主复制实现MySQL高可用.jpg">
<meta property="article:published_time" content="2021-03-11T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-26T02:21:50.346Z">
<meta property="article:author" content="SunnyWs">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/sunnyws/BlogAssets@master/img/blogimg/LVS+Keepalived+MySQL主主复制实现MySQL高可用.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://sunnyws.com/posts/c05f2321/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.3.0',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: SunnyWs","link":"链接: ","source":"来源: SunnyWs'Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2021-03-26 10:21:50'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = '1'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="baidu-site-verification" content="f3mDCE12Ro" /><link rel="stylesheet" href="//at.alicdn.com/t/font_2021129_6x83zxue7h.css"><style type="text/css">#toggle-sidebar {left:100px}</style><meta name="generator" content="Hexo 5.3.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="/img/favicon.png" onerror="onerror=null;src='/img/cover/index.jpg'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">29</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">12</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont icon-liuyan"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw iconfont icon-qita1"></i><span> 其他</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li></ul></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-Keepalived-MySQL%E4%B8%BB%E4%B8%BB%E5%A4%8D%E5%88%B6%E5%AE%9E%E7%8E%B0MySQL%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">LVS+Keepalived+MySQL主主复制实现MySQL高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LVS"><span class="toc-number">1.1.</span> <span class="toc-text">LVS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LVS%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.2.</span> <span class="toc-text">LVS能做什么?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-number">1.1.3.</span> <span class="toc-text">核心组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LVS%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.4.</span> <span class="toc-text">LVS模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LVS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="toc-number">1.1.5.</span> <span class="toc-text">LVS负载均衡调度算法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KeepAlived"><span class="toc-number">1.2.</span> <span class="toc-text">KeepAlived</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.2.</span> <span class="toc-text">运行原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#keepalived%E7%9A%84%E8%84%91%E8%A3%82"><span class="toc-number">1.2.3.</span> <span class="toc-text">keepalived的脑裂</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">1.3.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.1.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAMysql%E5%8F%8C%E4%B8%BB%E5%A4%8D%E5%88%B6"><span class="toc-number">1.3.2.</span> <span class="toc-text">搭建Mysql双主复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85keepalived"><span class="toc-number">1.3.3.</span> <span class="toc-text">安装keepalived</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AERS%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">1.3.4.</span> <span class="toc-text">配置RS服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.5.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.6.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/sunnyws/BlogAssets@master/img/blogimg/LVS+Keepalived+MySQL主主复制实现MySQL高可用.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">SunnyWs'Blog</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont icon-liuyan"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw iconfont icon-qita1"></i><span> 其他</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li></ul></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">LVS+Keepalived+MySQL主主复制实现MySQL高可用</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-03-11T16:00:00.000Z" title="发表于 2021-03-12 00:00:00">2021-03-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-03-26T02:21:50.346Z" title="更新于 2021-03-26 10:21:50">2021-03-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>24分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="LVS-Keepalived-MySQL主主复制实现MySQL高可用"><a href="#LVS-Keepalived-MySQL主主复制实现MySQL高可用" class="headerlink" title="LVS+Keepalived+MySQL主主复制实现MySQL高可用"></a>LVS+Keepalived+MySQL主主复制实现MySQL高可用</h2><h3 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a><strong>概述</strong></h4><ul>
<li>LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统， 是中国国内最早出现的自由软件项目之一。目前LVS已经被集成到Linux内核模块中 </li>
<li>LVS是Linux virtual server的缩写，为linux虚拟服务器，是一个虚拟的服务器集群系统。 LVS简单工作原理为用户请求LVS VIP，LVS根据转发方式和算法，将请求转发给后端服务器， 后端服务器接收到请求，返回给用户。对于用户来说，看不到Web后端具体的应用</li>
</ul>
<h4 id="LVS能做什么"><a href="#LVS能做什么" class="headerlink" title="LVS能做什么?"></a><strong>LVS能做什么?</strong></h4><p>LVS主要用于多服务器的负载均衡 </p>
<ul>
<li>LVS工作在网络层，可以实现高性能，高可用的服务器集群技术 </li>
<li> LVS廉价，可把许多低性能的服务器组合在一起形成一个超级服务器 </li>
<li>LVS易用，配置非常简单，且有多种负载均衡的方法 </li>
<li>稳定可靠，即使在集群的服务器中某台服务器无法正常工作，也不影响整体效果 </li>
<li>可扩展性也非常好</li>
</ul>
<h4 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a><strong>核心组件</strong></h4><p><strong>LVS的管理工具和内核模块 ipvsadm/ipvs</strong></p>
<ul>
<li><p>ipvsadm：用于空间的命令行工具, 用于管理集群服务及集群服务上的RS等 </p>
</li>
<li><p>ipvs：工作于内核上的程序, 可根据用户定义的集群实现请求转发 </p>
</li>
</ul>
<p><strong>专业术语</strong></p>
<ul>
<li>VS：Virtual Server，虚拟服务 </li>
<li>Director：负载均衡器，lvs调度器 </li>
<li>Balancer：分发器，lvs调度器 </li>
<li>RS：Real Server，后端请求处理服务器，web服务 </li>
<li>CIP：client ip，客户单ip </li>
<li>VIP：Director Virtural IP，负载均衡虚拟IP，lvs调度器上 </li>
<li> DIP：Director IP 负载均衡器ip </li>
<li>RIP：Real Server IP，后端请求处理服务器IP</li>
</ul>
<h4 id="LVS模式"><a href="#LVS模式" class="headerlink" title="LVS模式"></a><strong>LVS模式</strong></h4><ol>
<li><p><strong>NAT</strong></p>
<blockquote>
<p>NAT（Network Address Translation）即网络地址转换，其作用是通过数据报头的修改，使得位于企业内部的私有IP地址可以访问外网，以及外部用用户可以访问位于公司内部的私有IP主机。VS/NAT工作模式拓扑结构如图2所示，LVS负载调度器可以使用两块网卡配置不同的IP地址，eth0设置为私钥IP与内部网络通过交换设备相互连接，eth1设备为外网IP与外部网络联通。</p>
</blockquote>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/sunnyws/BlogAssets@master/img/contentimg/lvs1.png"></p>
</li>
<li><p><strong>TUN</strong></p>
<blockquote>
<p>在LVS（NAT）模式的集群环境中，由于所有的数据请求及响应的数据包都需要经过LVS调度器转发，如果后端服务器的数量大于10台，则调度器就会成为整个集群环境的瓶颈。我们知道，数据请求包往往远小于响应数据包的大小。因为响应数据包中包含有客户需要的具体数据，所以LVS（TUN）的思路就是将请求与响应数据分离，让调度器仅处理数据请求，而让真实服务器响应数据包直接返回给客户端。VS/TUN工作模式拓扑结构如图3所示。其中，IP隧道（IP tunning）是一种数据包封装技术，它可以将原始数据包封装并添加新的包头（内容包括新的源地址及端口、目标地址及端口），从而实现将一个目标为调度器的VIP地址的数据包封装，通过隧道转发给后端的真实服务器（Real Server），通过将客户端发往调度器的原始数据包封装，并在其基础上添加新的数据包头（修改目标地址为调度器选择出来的真实服务器的IP地址及对应端口），LVS（TUN）模式要求真实服务器可以直接与外部网络连接，真实服务器在收到请求数据包后直接给客户端主机响应数据。</p>
</blockquote>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/sunnyws/BlogAssets@master/img/contentimg/lvs2.png"></p>
</li>
<li><p><strong>DR（常用）</strong></p>
<blockquote>
<p> 在LVS（TUN）模式下，由于需要在LVS调度器与真实服务器之间创建隧道连接，这同样会增加服务器的负担。与LVS（TUN）类似，DR模式也叫直接路由模式，其体系结构如图4所示，该模式中LVS依然仅承担数据的入站请求以及根据算法选出合理的真实服务器，最终由后端真实服务器负责将响应数据包发送返回给客户端。与隧道模式不同的是，直接路由模式（DR模式）要求调度器与后端服务器必须在同一个局域网内，VIP地址需要在调度器与后端所有的服务器间共享，因为最终的真实服务器给客户端回应数据包时需要设置源IP为VIP地址，目标IP为客户端IP，这样客户端访问的是调度器的VIP地址，回应的源地址也依然是该VIP地址（真实服务器上的VIP），客户端是感觉不到后端服务器存在的。由于多台计算机都设置了同样一个VIP地址，所以在直接路由模式中要求调度器的VIP地址是对外可见的，客户端需要将请求数据包发送到调度器主机，而所有的真实服务器的VIP地址必须配置在Non-ARP的网络设备上，也就是该网络设备并不会向外广播自己的MAC及对应的IP地址，真实服务器的VIP对外界是不可见的，但真实服务器却可以接受目标地址VIP的网络请求，并在回应数据包时将源地址设置为该VIP地址。调度器根据算法在选出真实服务器后，在不修改数据报文的情况下，将数据帧的MAC地址修改为选出的真实服务器的MAC地址，通过交换机将该数据帧发给真实服务器。整个过程中，真实服务器的VIP不需要对外界可见。</p>
</blockquote>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/sunnyws/BlogAssets@master/img/contentimg/lvs3.png"></p>
</li>
</ol>
<h4 id="LVS负载均衡调度算法"><a href="#LVS负载均衡调度算法" class="headerlink" title="LVS负载均衡调度算法"></a><strong>LVS负载均衡调度算法</strong></h4><p>根据前面的介绍，我们了解了LVS的三种工作模式，但不管实际环境中采用的是哪种模式，调度算法进行调度的策略与算法都是LVS的核心技术，LVS在内核中主要实现了一下十种调度算法。</p>
<ol>
<li><p><strong>轮询调度</strong></p>
<blockquote>
<p>轮询调度（Round Robin 简称’RR’）算法就是按依次循环的方式将请求调度到不同的服务器上，该算法最大的特点就是实现简单。轮询算法假设所有的服务器处理请求的能力都一样的，调度器会将所有的请求平均分配给每个真实服务器。</p>
</blockquote>
</li>
<li><p><strong>加权轮询调度</strong></p>
<blockquote>
<p>加权轮询（Weight Round Robin 简称’WRR’）算法主要是对轮询算法的一种优化与补充，LVS会考虑每台服务器的性能，并给每台服务器添加一个权值，如果服务器A的权值为1，服务器B的权值为2，则调度器调度到服务器B的请求会是服务器A的两倍。权值越高的服务器，处理的请求越多。</p>
</blockquote>
</li>
<li><p><strong>最小连接调度</strong></p>
<blockquote>
<p>最小连接调度（Least Connections 简称’LC’）算法是把新的连接请求分配到当前连接数最小的服务器。最小连接调度是一种动态的调度算法，它通过服务器当前活跃的连接数来估计服务器的情况。调度器需要记录各个服务器已建立连接的数目，当一个请求被调度到某台服务器，其连接数加1；当连接中断或者超时，其连接数减1。</p>
</blockquote>
<p>（集群系统的真实服务器具有相近的系统性能，采用最小连接调度算法可以比较好地均衡负载。)</p>
</li>
<li><p><strong>加权最小连接调度</strong></p>
<blockquote>
<p>加权最少连接（Weight Least Connections 简称’WLC’）算法是最小连接调度的超集，各个服务器相应的权值表示其处理性能。服务器的缺省权值为1，系统管理员可以动态地设置服务器的权值。加权最小连接调度在调度新连接时尽可能使服务器的已建立连接数和其权值成比例。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</p>
</blockquote>
</li>
<li><p><strong>基于局部的最少连接</strong></p>
<blockquote>
<p>基于局部的最少连接调度（Locality-Based Least Connections 简称’LBLC’）算法是针对请求报文的目标IP地址的 负载均衡调度，目前主要用于Cache集群系统，因为在Cache集群客户请求报文的目标IP地址是变化的。这里假设任何后端服务器都可以处理任一请求，算法的设计目标是在服务器的负载基本平衡情况下，将相同目标IP地址的请求调度到同一台服务器，来提高各台服务器的访问局部性和Cache命中率，从而提升整个集群系统的处理能力。LBLC调度算法先根据请求的目标IP地址找出该目标IP地址最近使用的服务器，若该服务器是可用的且没有超载，将请求发送到该服务器；若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则使用’最少连接’的原则选出一个可用的服务器，将请求发送到服务器。</p>
</blockquote>
</li>
<li><p><strong>带复制的基于局部性的最少连接</strong></p>
<blockquote>
<p>带复制的基于局部性的最少连接（Locality-Based Least Connections with Replication  简称’LBLCR’）算法也是针对目标IP地址的负载均衡，目前主要用于Cache集群系统，它与LBLC算法不同之处是它要维护从一个目标IP地址到一组服务器的映射，而LBLC算法维护从一个目标IP地址到一台服务器的映射。按’最小连接’原则从该服务器组中选出一一台服务器，若服务器没有超载，将请求发送到该服务器；若服务器超载，则按’最小连接’原则从整个集群中选出一台服务器，将该服务器加入到这个服务器组中，将请求发送到该服务器。同时，当该服务器组有一段时间没有被修改，将最忙的服务器从服务器组中删除，以降低复制的程度。</p>
</blockquote>
</li>
<li><p><strong>目标地址散列调度</strong></p>
<blockquote>
<p>目标地址散列调度（Destination Hashing 简称’DH’）算法先根据请求的目标IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且并未超载，将请求发送到该服务器，否则返回空。</p>
</blockquote>
</li>
<li><p><strong>源地址散列调度U</strong></p>
<blockquote>
<p>源地址散列调度（Source Hashing  简称’SH’）算法先根据请求的源IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且并未超载，将请求发送到该服务器，否则返回空。它采用的散列函数与目标地址散列调度算法的相同，它的算法流程与目标地址散列调度算法的基本相似。</p>
</blockquote>
</li>
<li><p><strong>最短的期望的延迟</strong></p>
<blockquote>
<p>最短的期望的延迟调度（Shortest Expected Delay 简称’SED’）算法基于WLC算法。举个例子吧，ABC三台服务器的权重分别为1、2、3 。那么如果使用WLC算法的话一个新请求进入时它可能会分给ABC中的任意一个。使用SED算法后会进行一个运算</p>
<p>A：（1+1）/1=2   B：（1+2）/2=3/2   C：（1+3）/3=4/3   就把请求交给得出运算结果最小的服务器。</p>
</blockquote>
</li>
<li><p><strong>最少队列调度</strong></p>
<blockquote>
<p>最少队列调度（Never Queue 简称’NQ’）算法，无需队列。如果有realserver的连接数等于0就直接分配过去，不需要在进行SED运算。</p>
</blockquote>
</li>
</ol>
<h3 id="KeepAlived"><a href="#KeepAlived" class="headerlink" title="KeepAlived"></a>KeepAlived</h3><h4 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a><strong>概述</strong></h4><p>keepalived起初就是为LVS设计的，专门用来监控集群系统中各个服务节点的状态，它根据 TCP/IP参考模型的第三、四和第五层交换机制检测每个服务节点的状态，每个服务节点异常 或者工作障碍，keepalvied将立刻检测到，并把障碍节点剔除，是毫秒级的，当后台节点恢 复正常以后，keepalived有自动将服务节点重新添加在服务器集群中</p>
<p>keepalvied后来增加vrrp功能，vrrp（虚拟路由器冗余协议），出现的目的就是解决静态路 由单点故障的问题，通过vrrp可以实现网络不间断稳定运行</p>
<h4 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a><strong>运行原理</strong></h4><p>keepalived 通过选举（服务器设置的权重）挑选出一台热备服务器做 MASTER 机器，MASTER 机器会被分 配到一个指定的虚拟 ip，即VIP, 外部程序可通过该 VIP 访问这台服务器，如果这台服务器出现故障（断网， 重启，或者本机器上的 keepalived crash 等），keepalived 会从其他的备份机器上重选（还是看服务器设 置的权重）一台机器做 MASTER 并分配同样的虚拟 IP，充当前一台 MASTER 的角色。权重越高，备用机器 被拉起来的占比就越大，一般的主备就可以满足需求 </p>
<p><strong>选举策略</strong></p>
<p>选举策略是根据VRRP协议，完全按照权重大小，权重最大的是 MASTER 机器，下面几种情况会触发选举</p>
<blockquote>
<ul>
<li>keepalived 启动的时候 ,master 服务器出现故障（断网，重启，或者本机器上的 keepalived crash 等，而本机器上其他应用程序 crash 不 算） </li>
<li>keepalived 启动的时候 ,有新的备份服务器加入且权重最大</li>
</ul>
</blockquote>
<h4 id="keepalived的脑裂"><a href="#keepalived的脑裂" class="headerlink" title="keepalived的脑裂"></a><strong>keepalived的脑裂</strong></h4><p><strong>什么是脑裂?</strong></p>
<blockquote>
<p>在高可用系统中，作为主备节点的两台服务器，可能因为一些比如说网络断开，两台机器的心跳 检测会认为主挂了，但是主其实是正常的，只是网络断开了，心跳检测没法检查到主还活着，由 于主从之间失去了联系，都以为是对方发生了故障，所以两个节点都会主动的抢占资源，争抢应 用服务，争抢VIP，这样就发发生一些严重的后果，或者资源被瓜分了、或者是两边的节点都启动 不起来了、或者是都起来了，但是同时读写共享存储，导致数据损坏</p>
</blockquote>
<p><strong>脑裂产生的原因</strong></p>
<blockquote>
<ul>
<li>高可用服务器对之间心跳线链路发生故障，导致无法正常通信 l 因心跳线断开（包括网线断裂、水晶头松动等物理原因）因网卡及相关驱动坏了，ip配置及冲突问题（网卡直连） l 因心跳线间连接的设备故障（网卡及交换机）</li>
<li>因仲裁的机器出问题（采用仲裁的方案） l 高可用服务器上开启了 iptables防火墙阻挡了心跳消息传输</li>
<li>高可用服务器上心跳网卡地址等信息配置不正确，导致发送心跳失败</li>
<li>其他服务配置不当等原因，如心跳方式不同，心跳广插冲突、软件Bug等</li>
</ul>
</blockquote>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a><strong>环境</strong></h4><ul>
<li>centos7.5</li>
<li>mysql8.0</li>
</ul>
<table>
<thead>
<tr>
<th>节点编号</th>
<th>IP地址</th>
<th>节点类型</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>172.16.220.10</td>
<td>Keepalived Master</td>
</tr>
<tr>
<td>2</td>
<td>172.16.220.20</td>
<td>Keepalived Slave</td>
</tr>
<tr>
<td>3</td>
<td>172.16.220.30</td>
<td>Mysql Server1</td>
</tr>
<tr>
<td>4</td>
<td>172.16.220.40</td>
<td>Mysql Server1</td>
</tr>
<tr>
<td>/</td>
<td>172.16.220.100</td>
<td>虚拟IP（VIP）</td>
</tr>
</tbody></table>
<h4 id="搭建Mysql双主复制"><a href="#搭建Mysql双主复制" class="headerlink" title="搭建Mysql双主复制"></a><strong>搭建Mysql双主复制</strong></h4><p><a href="https://sunnyws.com/2021/03/11/Mysql%E5%8F%8C%E4%B8%BB%E5%A4%8D%E5%88%B6/">https://sunnyws.com/2021/03/11/Mysql%E5%8F%8C%E4%B8%BB%E5%A4%8D%E5%88%B6/</a></p>
<h4 id="安装keepalived"><a href="#安装keepalived" class="headerlink" title="安装keepalived"></a><strong>安装keepalived</strong></h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">yum 安装</span></span><br><span class="line">yum install -y keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash">查看版本</span></span><br><span class="line">keepalived -v</span><br><span class="line"><span class="meta">#</span><span class="bash">安装ipvsadm</span>  </span><br><span class="line">yum  install -y  ipvsadm</span><br></pre></td></tr></table></figure>
<p><strong>修改keepalived配置</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>
<p>修改<strong>172.16.220.10</strong>配置为以下内容</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"> global_defs &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> notification_email &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    518@msn.cn                                  <span class="comment"># 发生故障时发送的邮箱  这里没有smtp服务 暂时注释掉</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   &#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   notification_email_from linuxzen@linuxzen.com             <span class="comment"># 使用哪个邮箱发送</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   smtp_server linuxzen.com                                  <span class="comment"># 发件服务器</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   smtp_connect_timeout 30</span></span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER             # 标示为主lvs</span><br><span class="line">    interface ens33          # HA检测端口,根据实际网卡名称，也可能是eth1,或ens33</span><br><span class="line">    virtual_router_id 51     # 主备的virtual_router_id 必须相同</span><br><span class="line">    priority 100             # 优先级,备lvs要比主lvs稍小</span><br><span class="line">    advert_int 1             # VRRP Multicast 广播周期秒数</span><br><span class="line">    authentication &#123;         # 定义认证</span><br><span class="line">        auth_type PASS       # 认证方式为口令认证</span><br><span class="line">        auth_pass 123456     # 定义口令</span><br><span class="line">   &#125;</span><br><span class="line">    virtual_ipaddress &#123;      # 定义vip</span><br><span class="line">       172.16.220.100        # 多个vip可换行添加</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">virtual_server 172.16.220.100 3306 &#123;</span><br><span class="line">    delay_loop 6                # 每隔6秒查看realserver状态</span><br><span class="line">    lb_algo rr                  # 调度算法为轮询</span><br><span class="line">    lb_kind DR                  # lvs工作模式为DR(直接路由)模式</span><br><span class="line">    persistence_timeout 0</span><br><span class="line">    protocol TCP                # 用TCP监测realserver的状态</span><br><span class="line"></span><br><span class="line">    real_server 172.16.220.30 3306 &#123;    # 定义realserver</span><br><span class="line">        weight 1                        # 定义权重</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 3           # 三秒无响应超时</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 3306</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 172.16.220.40 3306 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 3306</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改<strong>172.16.220.20</strong>配置为以下内容</p>
<ul>
<li>1.将state MASTER 改为state BACKUP</li>
<li>2.降低priority 100 的值，如priority 90，优先级高的当选为master，低的当选为BACKUP</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"> global_defs &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> notification_email &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    518@msn.cn                                  <span class="comment"># 发生故障时发送的邮箱  这里没有smtp服务 暂时注释掉</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   &#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   notification_email_from linuxzen@linuxzen.com             <span class="comment"># 使用哪个邮箱发送</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   smtp_server linuxzen.com                                  <span class="comment"># 发件服务器</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   smtp_connect_timeout 30</span></span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP             # 标示为备lvs</span><br><span class="line">    interface ens33          # HA检测端口,根据实际网卡名称，也可能是eth1,或ens33</span><br><span class="line">    virtual_router_id 51     # 主备的virtual_router_id 必须相同</span><br><span class="line">    priority 80             # 优先级,备lvs要比主lvs稍小</span><br><span class="line">    advert_int 1             # VRRP Multicast 广播周期秒数</span><br><span class="line">    authentication &#123;         # 定义认证</span><br><span class="line">        auth_type PASS       # 认证方式为口令认证</span><br><span class="line">        auth_pass 123456     # 定义口令</span><br><span class="line">   &#125;</span><br><span class="line">    virtual_ipaddress &#123;      # 定义vip</span><br><span class="line">       172.16.220.100        # 多个vip可换行添加</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">virtual_server 172.16.220.100 3306 &#123;</span><br><span class="line">    delay_loop 6                # 每隔6秒查看realserver状态</span><br><span class="line">    lb_algo rr                  # 调度算法为轮询</span><br><span class="line">    lb_kind DR                  # lvs工作模式为DR(直接路由)模式</span><br><span class="line">    persistence_timeout 0</span><br><span class="line">    protocol TCP                # 用TCP监测realserver的状态</span><br><span class="line"></span><br><span class="line">    real_server 172.16.220.30 3306 &#123;    # 定义realserver</span><br><span class="line">        weight 1                        # 定义权重</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 3           # 三秒无响应超时</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 3306</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 172.16.220.40 3306 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 3306</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>重启<code>keepalived</code></strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">重启keepalived</span></span><br><span class="line">systemctl restart  keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash">查看keepalived状态</span></span><br><span class="line">systemctl status  keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash">设置开机自启</span></span><br><span class="line">systemctl  enable keepalived</span><br></pre></td></tr></table></figure>
<h4 id="配置RS服务端"><a href="#配置RS服务端" class="headerlink" title="配置RS服务端"></a><strong>配置<code>RS服务端</code></strong></h4><p>这里主要是DR模式</p>
<p><strong>在<code>RS</code>上（这里是<code>172.16.220.30</code>和<code>172.16.220.40</code>）修改配置</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">执行下面命令</span></span><br><span class="line">ifconfig lo:0 172.16.220.100 netmask 255.255.255.255 broadcast 172.16.220.100</span><br><span class="line">/sbin/route add -host 172.16.220.100 dev lo:0</span><br><span class="line"> echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"> echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line"> echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"> echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"> sysctl -p </span><br></pre></td></tr></table></figure>
<p><strong>设置开机执行</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim  /etc/rc.local </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">添加配置</span></span><br><span class="line">ifconfig lo:0 172.16.220.100 netmask 255.255.255.255 broadcast 172.16.220.100</span><br><span class="line">/sbin/route add -host 172.16.220.100 dev lo:0</span><br><span class="line"> echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"> echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line"> echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"> echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"> sysctl -p </span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">赋予执行权限</span></span><br><span class="line">chmod a+x /etc/rc.local </span><br></pre></td></tr></table></figure>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a><strong>问题</strong></h4><p><strong>1.多个vip, 为什么dns会把请求打到LVS上, 而没有打到RS上呢？</strong></p>
<blockquote>
<ul>
<li><p>理解LVS的DR模式, 要解决这个问题, 就需要了解ARP请求, 需要在LVS, RS1, RS2上都需要绑定多个VIP, 但是需要在RS1和RS2上需要额外的做一些工作, 禁止ARP请求</p>
<blockquote>
<p>echo “1” &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore </p>
<p>echo “2” &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</p>
<p>echo “1” &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</p>
<p>echo “2” &gt; /proc/sys/net/ipv4/conf/all/arp_announce</p>
</blockquote>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>LVS服务器是正常的情况下, 当DNS在请求的时候会解析出来VIP的地址, 但并不知道, 具体的mac 地址是哪一个, LVS服务器会通过ARP请求, 告知别人自己的mac地址, 别人就缓存下来了, 反之, RS 是禁止ARP请求的, 不相应其他机器的请求， 别人就不知道他的mac地址, 即使他有VIP地址, 所以 DNS只会把请求转发到LVS上, 而不能转发到RS上。</li>
</ul>
</blockquote>
<p><strong>2.既然RS禁止了ARP请求, 那LVS如何把请求转发给RS呢?</strong></p>
<blockquote>
<ul>
<li><p>是通过修改mac地址, 进行转发 的, 这个是DR模式的核心。</p>
</li>
<li><p>LVS又是如何知道RS的mac地址呢？</p>
<p>arp_ignore:定义对目标地址为本地IP的ARP询问不同的应答模式 </p>
<blockquote>
<p>0 (默认值): 回应任何网络接口上对任何本地IP地址的arp查询请求 </p>
<p>1 只回答目标IP地址是来访网络接口本地地址的ARP查询请求 </p>
<p>2 只回答目标IP地址是来访网络接口本地地址的ARP查询请求,且来访IP必须在该网络接口的子网段内</p>
<p>3 不回应该网络界面的arp请求，而只对设置的唯一和连接地址做出回应</p>
<p>4-7 保留未使用 • 8 不回应所有（本地地址）的arp查询</p>
</blockquote>
</li>
</ul>
</blockquote>
<p><strong>3.RS是如何做到, 直接返回给客户端的呢?</strong></p>
<blockquote>
<ul>
<li><p>通常情况下，接收的请求, 应该都是哪里来, 哪里回, 那RS是如何做到直接返回个客户端的呢? </p>
</li>
<li><p>arp_announce这个内核参数, 其实就是让RS可直接返回给客户端，arp_announce:对网络接口上，本 地IP地址的发出的，ARP回应，作出相应级别的限制: 确定不同程度的限制,宣布对来自本地源IP地址发 出Arp请求的接口</p>
<blockquote>
<p>0 - (默认) 在任意网络接口上的任何本地地址 </p>
<p>1 -尽量避免不在该网络接口子网段的本地地址做出arp回应. 当发起ARP请求的源IP地址是被设置应该经由路由 达到此网络接口的时候很有用.此时会检查来访IP是否为所有接口上的子网段内ip之一.如果改来访IP不属于各个 网络接口上的子网段内,那将采用级别2的方式来进行处理.</p>
<p>2 - 对查询目标使用最适当的本地地址.在此模式下将忽略这个IP数据包的源地址并尝试选择与能与该地址通信 的本地地址.首要是选择所有的网络接口的子网中外出访问子网中包含该目标IP地址的本地地址. 如果没有合适 的地址被发现,将选择当前的发送网络接口或其他的有可能接受到该ARP回应的网络接口来进行发送</p>
</blockquote>
</li>
</ul>
</blockquote>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a><strong>测试</strong></h4><p><strong>1.测试连接是否轮询</strong></p>
<p>本地通过<code>VIP(172.16.220.100)</code>创建多个连接  连接服务器数据库<strong>（测试轮询时，最好将 persistence_timeout 设为0）</strong>   </p>
<p>在Keepalived Master(172.16.220.10)查看ActiveConn变化</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">使用的轮询算法   创建3个数据库连接  查看</span></span><br><span class="line">[root@10 ~]# ipvsadm</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10:mysql rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.16.220.30:mysql          Route   1      2          0</span>         </span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.16.220.40:mysql          Route   1      1          0</span>      </span><br></pre></td></tr></table></figure>
<p><strong>2.Keepalived 是否可以master和backup自动切换</strong></p>
<ul>
<li>使用ip addr show 命令查看servera或者serverb时，如果发现172.16.220.200的ip 附加在ens33的网卡上面，说明该机器就是master</li>
<li>master和backup切换，当master关机或者关闭keepalived服务的时，172.16.220.200这个IP地址将会漂移到backup机器，并接管服务</li>
<li>master重启keepalived后，会再次接管VIP</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">切换前</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 172.16.220.10  机器</span></span><br><span class="line">[root@10 ~]# ip addr show</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:74:13:ae brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.16.220.10/24 brd 172.16.220.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 172.16.220.100/32 scope global ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::cf07:9c93:1f0a:2324/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta">#</span><span class="bash"> 172.16.220.20  机器</span></span><br><span class="line">[root@20 ~]# ip addr show</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:27:a8:47 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.16.220.20/24 brd 172.16.220.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::cf07:9c93:1f0a:2324/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::9aa0:13fd:7859:598b/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">172.16.220.10 停止keepalived</span></span><br><span class="line">[root@10 ~]# systemctl stop keepalived</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">切换后</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 172.16.220.10  机器</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:74:13:ae brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.16.220.10/24 brd 172.16.220.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::cf07:9c93:1f0a:2324/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta">#</span><span class="bash"> 172.16.220.20  机器</span> </span><br><span class="line">[root@20 ~]# ip addr show</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:27:a8:47 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.16.220.20/24 brd 172.16.220.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 172.16.220.100/32 scope global ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::cf07:9c93:1f0a:2324/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::9aa0:13fd:7859:598b/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p><strong>3.停止一个RS服务，是否剔除障碍节点</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">停止172.16.220.30 节点 mysql 服务</span></span><br><span class="line">[root@30 ~]# systemctl stop mysqld.service</span><br><span class="line"><span class="meta">#</span><span class="bash">172.16.220.10  查看</span> </span><br><span class="line">[root@10 ~]# ipvsadm</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10:mysql rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.16.220.40:mysql          Route   1      0          0</span>    </span><br><span class="line"><span class="meta">#</span><span class="bash">创建3个连接 查看</span>   </span><br><span class="line">[root@10 ~]# ipvsadm</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10:mysql rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.16.220.40:mysql          Route   1      3          0</span>  </span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">SunnyWs</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://sunnyws.com/posts/c05f2321/">https://sunnyws.com/posts/c05f2321/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://sunnyws.com" target="_blank">SunnyWs'Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/sunnyws/BlogAssets@master/img/blogimg/LVS+Keepalived+MySQL主主复制实现MySQL高可用.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/wechat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.png" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/alipay.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/posts/5ac39a6e/"><img class="next-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/sunnyws/BlogAssets@master/img/blogimg/Mysql双主复制.jpg" onerror="onerror=null;src='/img/cover/index.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Mysql双主复制</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/sunnyws/BlogAssets@master/img/blogimg/LVS+Keepalived+MySQL主主复制实现MySQL高可用.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By SunnyWs</div><div class="icp"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn/#/Integrated/recordQuery"><span>豫ICP备19019070号-1</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const initData = {
      el: '#vcomment',
      appId: 'T2GJNCM0qQ4YiRqifywyUvbI-gzGzoHsz',
      appKey: 'lc9PIjqrN3NDslBgWu7aVg7r',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: {"1":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/1.gif","2":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/2.gif","3":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/3.gif","4":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/4.gif","5":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/5.gif","6":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/6.gif","7":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/7.gif","8":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/8.gif","9":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/9.gif","10":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/10.gif","11":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/11.gif","12":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/12.gif","13":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/13.gif","14":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/14.gif","15":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/15.gif","16":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/16.gif","17":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/17.gif","18":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/18.gif","19":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/19.gif","20":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/20.gif","21":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/21.gif","22":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/22.gif","23":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/23.gif","24":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/24.gif","25":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/25.gif","26":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/26.gif","27":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/27.gif","28":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/28.gif","29":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/29.gif","30":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/30.gif","31":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/31.gif","32":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/32.gif","33":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/33.gif","34":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/34.gif","35":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/35.gif","36":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/36.gif","37":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/37.gif","38":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/38.gif","39":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/39.gif","40":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/40.gif","41":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/41.gif","42":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/42.gif","43":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/43.gif","44":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/44.gif","45":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/45.gif","46":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/46.gif","47":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/47.gif","48":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/48.gif","49":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/49.gif","50":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/50.gif","51":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/51.gif","52":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/52.gif","53":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/53.gif","54":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/54.gif","55":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/55.gif","56":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/56.gif","57":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/57.gif","58":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/58.gif","59":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/59.gif","60":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/60.gif","61":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/61.gif","62":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/62.gif","63":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/63.gif","64":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/64.gif","65":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/65.gif","66":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/66.gif","67":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/67.gif","68":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/68.gif","69":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/69.gif","70":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/70.gif","71":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/71.gif","72":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/72.gif","73":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/73.gif","74":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/74.gif","75":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/75.gif","76":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/76.gif","77":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/77.gif","78":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/78.gif","79":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/79.gif","80":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/80.gif","81":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/81.gif","82":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/82.gif","83":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/83.gif","84":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/84.gif","85":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/85.gif","86":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/86.gif","87":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/87.gif","88":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/88.gif","89":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/89.gif","90":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/90.gif","91":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/91.gif","92":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/92.gif","93":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/93.gif","94":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/94.gif","95":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/95.gif","96":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/96.gif","97":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/97.gif","98":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/98.gif","99":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/99.gif","100":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/100.gif","101":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/101.gif","102":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/102.gif","103":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/103.gif","104":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/104.gif","105":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/105.gif","106":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/106.gif","107":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/107.gif","108":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/108.gif","109":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/109.gif","110":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/110.gif","111":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/111.gif","112":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/112.gif","113":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/113.gif","114":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/114.gif","115":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/115.gif","116":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/116.gif","117":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/117.gif","118":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/118.gif","119":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/119.gif","120":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/120.gif","121":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/121.gif","122":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/122.gif","123":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/123.gif","124":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/124.gif","125":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/125.gif","126":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/126.gif","127":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/127.gif","128":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/128.gif","129":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/129.gif","130":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/130.gif","131":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/131.gif","132":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/132.gif","133":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/133.gif","134":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/134.gif","135":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/135.gif","136":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/136.gif","137":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/137.gif","138":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/138.gif","139":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/139.gif","140":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/140.gif","141":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/141.gif","142":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/142.gif","143":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/143.gif","144":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/144.gif","145":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/145.gif","146":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/146.gif","147":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/147.gif","148":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/148.gif","149":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/149.gif","150":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/150.gif","151":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/151.gif","152":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/152.gif","153":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/153.gif","154":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/154.gif","155":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/155.gif","156":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/156.gif","157":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/157.gif","158":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/158.gif","159":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/159.gif","160":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/160.gif","161":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/161.gif","162":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/162.gif","163":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/163.gif","164":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/164.gif","165":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/165.gif","166":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/166.gif","167":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/167.gif","168":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/168.gif","169":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/169.gif","170":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/170.gif","171":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/171.gif","172":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/172.gif","173":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/173.gif","174":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/174.gif","175":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/175.gif","176":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/176.gif","177":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/177.gif","178":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/178.gif","179":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/179.gif","180":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/180.gif","181":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/181.gif","182":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/182.gif","183":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/183.gif","184":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/184.gif","185":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/185.gif","186":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/186.gif","187":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/187.gif","188":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/188.gif","189":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/189.gif","190":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/190.gif","191":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/191.gif","192":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/192.gif","193":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/193.gif","194":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/0.gif","195":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/195.gif","196":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/196.gif","197":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/197.gif","198":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/198.gif","199":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/199.gif","200":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/200.gif","201":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/201.gif","202":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/202.gif","203":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/203.gif","204":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/204.gif","205":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/205.gif","206":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/206.gif","207":"https://cdn.jsdelivr.net/gh/blogimg/emotion/qq_2020f/207.gif"},
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick,mail'.split(','))
    }

    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div class="aplayer no-destroy" data-id="7687642830" data-server="tencent" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config_change',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  $('script[data-pjax]').each(function () {
    $(this).parent().append($(this).remove())
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  $(window).off('scroll')

  //reset readmode
  $('body').hasClass('read-mode') && $('body').removeClass('read-mode')

})</script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/haruto.model.json"},"log":false});</script></body></html>